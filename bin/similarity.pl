#!/usr/bin/perl
use strict;
use FileHandle;
use Cwd;

use constant FILE_DIR => '/files';
use constant FH_DIR => '/files/FH';
use constant PAIR_INFO => 'pair.txt';
use constant WORK_LIST => 'work.txt';
use constant DIS_INFO => 'distance.txt';
use constant REMAIN_INFO => 'remain.txt';
use constant RESULT_INFO => 'result.txt';
use constant FINISH_CODE => 99;
use constant BOUNDARY => 0.98;
use constant NOTICE => 'FIN';
use constant WARN => 'ERROR';
use constant WEND => 'END';

my @distance;
my @pairList;
my @workList;
my $execCode;
my %pairIndex;

my $homedir = getcwd;
chdir($homedir.FILE_DIR);
my $fh = FileHandle->new(PAIR_INFO);
while($_ = $fh->getline) {
    my @tQueue = split(" ", $_);
    push(@{$pairList[0]}, $tQueue[0]);
    push(@{$pairList[1]}, $tQueue[1]);
}
undef $fh;
for(my $i = 0; $i <= $#{$pairList[0]}; ++$i) {
    $pairIndex{$pairList[0][$i]} = $i;
}
$fh = FileHandle->new(WORK_LIST);
while($_ = $fh->getline) {
    my @tQueue = split(" ", $_);
    push(@{$workList[0]}, $tQueue[0]);
    push(@{$workList[1]}, $tQueue[1]);
}
undef $fh;
chdir($homedir.FH_DIR);
$fh = FileHandle->new(DIS_INFO);
while($_ = $fh->getline) {
    my @tQueue = split(" ", $_);
    push(@distance, \@tQueue);
}
undef $fh;

chdir($homedir.FILE_DIR);
$fh = FileHandle->new(">".REMAIN_INFO);
my $fh2 = FileHandle->new(">>".RESULT_INFO);
for(my $i = 0; $i <= $#{$workList[0]}; ++$i) {
    my $index = $pairIndex{$workList[0][$i]};
    my $maxSim = 0.0;
    my $maxSimIndex = -1;
    for(my $j = 0; $j <= $#{$distance[0]}; ++$j) {
        if($distance[$index][$j] > $maxSim) {
            $maxSim = $distance[$index][$j];
            $maxSimIndex = $j;
        }
    }
    if($maxSim >= BOUNDARY) {
        print $fh2 $workList[0][$i]." ".FINISH_CODE." ".$pairList[1][$maxSimIndex]."\n";
    } else {
        print $fh $workList[0][$i]." ".$workList[1][$i]."\n";
    }
}
undef $fh;
undef $fh2;

print NOTICE."\n";
