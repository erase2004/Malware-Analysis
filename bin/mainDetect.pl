#!/usr/bin/perl
use strict;
use FileHandle;
use Cwd;
use threads;
use threads::shared;

use constant FILE_DIR => '/files';
use constant BIN_DIR => '/bin';
use constant REMAIN_INFO => 'remain.txt';
use constant THREAD_NUM => 4;

my @remainList;
my $execCode;

sub Detection;

chdir('..');
my $homedir = getcwd;
chdir($homedir.FILE_DIR);
my $fh = FileHandle->new(REMAIN_INFO);
while($_ = $fh->getline) {
    push(@remainList, substr($_, 0, (length($_) - 1)));
}
undef $fh;

for(my $i = 0; $i <= $#remainList; ++$i) {
    chdir($remainList[$i]);
    my $curDir = getcwd;
    opendir(my $dh, $curDir);
    my @dexFile = grep { /.dex$/i } readdir($dh);
    close($dh);
    if($#dexFile < 0) {
        next;
    }
    $execCode = $homedir.BIN_DIR."\/dex2jar\/d2j-dex2jar.sh ".$dexFile[0];
    `$execCode`;
    chdir($homedir.FILE_DIR);
}

my @thread;
for(my $i = 0; $i < THREAD_NUM; ++$i) {
    $thread[$i] = threads->new(\&Detection, $i);
}
for(my $i = 0; $i < THREAD_NUM; ++$i) {
    $thread[$i]->join;
}

sub Detection {
    my $start = shift;
    for(my $j = $start; $j <= $#remainList; $j = $j + THREAD_NUM) {
        my $curDir = $remainList[$j];
        opendir(my $dh, $curDir);
        my @dexFile = grep { /.dex$/i } readdir($dh);
        close($dh);
        if($#dexFile < 0) {
            next;
        }
        $dexFile[0] = substr($dexFile[0], 0, (length($dexFile[0]) - 4))."\-dex2jar.jar";
        my $exCode = "perl ".$homedir.BIN_DIR."\/CallGraphAnalysis.pl ".$remainList[$j]."\/".$dexFile[0]." ".$homedir;
        `$exCode`;
    }
}
