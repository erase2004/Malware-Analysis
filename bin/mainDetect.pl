#!/usr/bin/perl
use strict;
use FileHandle;
use Cwd;
use threads;
use threads::shared;

use constant FILE_DIR => '/files';
use constant BIN_DIR => '/bin';
use constant REMAIN_INFO => 'remain.txt';
use constant RESULT_INFO => 'result.txt';
use constant FINISH_CODE => 99;
use constant THREAD_NUM => 4;
use constant NOTICE => 'FIN';
use constant WARN => 'ERROR';
use constant WEND => 'END';

my @apkList;
my @remainList;
my @condCodeList;
my $execCode;

sub Detection;

my $homedir = getcwd;
chdir($homedir.FILE_DIR);
my $fh = FileHandle->new(REMAIN_INFO);
while($_ = $fh->getline) {
    my @tQueue = split(" ",$_);
    push(@apkList, $tQueue[0]);
    push(@remainList, $tQueue[1]);
}
undef $fh;

$fh = FileHandle->new(">>".RESULT_INFO);
for(my $i = 0; $i <= $#remainList; ++$i) {
    chdir($remainList[$i]);
    my $curDir = getcwd;
    opendir(my $dh, $curDir);
    my @dexFile = grep { /.dex$/i } readdir($dh);
    close($dh);
    if($#dexFile < 0) {
        push(@condCodeList, 21);
        print $fh $apkList[$i]." ".$condCodeList[$i]."\n";
        next;
    }
    $execCode = $homedir.BIN_DIR."\/dex2jar\/d2j-dex2jar.sh ".$dexFile[0];
    `$execCode 2>&1`;
    push(@condCodeList, 20);
    chdir($homedir.FILE_DIR);
}
undef $fh;

my @thread;
for(my $i = 0; $i < THREAD_NUM; ++$i) {
    $thread[$i] = threads->new(\&Detection, $i);
}
for(my $i = 0; $i < THREAD_NUM; ++$i) {
    $thread[$i]->join;
}

$fh = FileHandle->new(">>".RESULT_INFO);
for(my $i = 0; $i < $#remainList; ++$i) {
    if($condCodeList[$i] == 20) {
        print $fh $apkList[$i]." ".FINISH_CODE." ".$remainList[$i]."\n";
    }
}
undef $fh;
print NOTICE."\n";

sub Detection {
    my $start = shift;
    for(my $j = $start; $j <= $#remainList; $j = $j + THREAD_NUM) {
        if($condCodeList[$j] != 20) {
            next;
        }
        my $curDir = $remainList[$j];
        opendir(my $dh, $curDir);
        my @dexFile = grep { /.dex$/i } readdir($dh);
        close($dh);
        $dexFile[0] = substr($dexFile[0], 0, (length($dexFile[0]) - 4))."\-dex2jar.jar";
        my $exCode = "perl ".$homedir.BIN_DIR."\/CallGraphAnalysis.pl ".$apkList[$j]." ".$remainList[$j]."\/".$dexFile[0]." ".$homedir;
        `$exCode`;
    }
}
