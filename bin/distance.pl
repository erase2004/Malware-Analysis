#!/usr/bin/perl
use strict;
use FileHandle;
use Cwd;

use constant FILE_DIR => '/files';
use constant FH_DIR => '/files/FH';
use constant FH_TEMP_INFO => 'FHTemp.txt';
use constant FH_LIST => 'FHList.txt';
use constant DIS_INFO => 'distance.txt';
use constant NOTICE => 'FIN';
use constant WARN => 'ERROR';
use constant WEND => 'END';

my @distance;
my @FHList1;
my @FHList2;
my $execCode;

sub JaccardSim;

chdir('..');
my $homedir = getcwd;
chdir($homedir.FH_DIR);
my $fh;
$fh = FileHandle->new(DIS_INFO) || ( $fh = FileHandle->new(">".DIS_INFO), undef $fh, $fh = FileHandle->new(DIS_INFO));
my $tempLine;
my $index = 0;
while($tempLine = $fh->getline) {
    my @temp = split(' ',$tempLine);
    $distance[$index] = \@temp;
    $index++;
}
undef $fh;

$index = 0;
$fh = FileHandle->new(FH_LIST) || ( $fh = FileHandle->new(">".FH_LIST), undef $fh, $fh = FileHandle->new(FH_LIST));
while($_ = $fh->getline) {
    push @FHList1, $_;
    $index++;
}
undef $fh;

my $mSize = $index;
$index = 0;
$fh = FileHandle->new(FH_TEMP_INFO);
while($_ = $fh->getline) {
    push @FHList2, $_;
    $index++;
}
undef $fh;
my $nSize = $index;

for(my $i = 0; $i < $mSize; ++$i) {
    my $sim;
    $tempLine = substr($FHList1[$i],0,length($FHList1[$i])-1);
    my $content1 = $tempLine;
    for(my $j = 0; $j < $nSize; ++$j) {
        $tempLine = substr($FHList2[$j],0,length($FHList2[$j])-1);
        my $content2 = $tempLine;
        $sim = JaccardSim($content1, $content2);
        $distance[$i][$mSize+$j] = $sim;
        $distance[$mSize+$j][$i] = $sim;
    }
}
for(my $i = 0; $i < $nSize; ++$i) {
    my $sim;
    $tempLine = substr($FHList2[$i],0,length($FHList2[$i])-1);
    my $content1 = $tempLine;
    for(my $j = $i+1; $j < $nSize; ++$j) {
        $tempLine = substr($FHList2[$j],0,length($FHList2[$j])-1);
        my $content2 = $tempLine;
        $sim = JaccardSim($content1, $content2);
        $distance[$mSize+$i][$mSize+$j] = $sim;
        $distance[$mSize+$j][$mSize+$i] = $sim;
    }
}

my $size = $mSize + $nSize;
for(my $i = 0; $i < $size; ++$i) {
    $distance[$i][$i] = 0;
}

$fh = FileHandle->new(">>".FH_LIST);
for(my $i = 0; $i <= $#FHList2; ++$i) {
    print $fh $FHList2[$i];
}
undef $fh;

$fh = FileHandle->new(">".DIS_INFO);
for(my $i = 0; $i < $size; ++$i) {
    for(my $j = 0; $j < $size; ++$j) {
        print $fh sprintf("%.8f ",$distance[$i][$j]);
    }
    print $fh "\n";
}
undef $fh;
print NOTICE."\n";

sub JaccardSim {
    my $str1 = shift;
    my $str2 = shift;
    my $intersection = $str1 & $str2;
    my $union = $str1 | $str2;
    my $count1 = 0;
    my $count2 = 0;
    while($intersection =~ /1/g) { $count1++; }
    while($union =~ /1/g) { $count2++; }
    if($count2 == 0){ return 0; }
    return ( $count1 / $count2 );
}
