#!/usr/bin/perl
use strict;
use FileHandle;
use threads;
use threads::shared;
use Cwd;

use constant FILE_DIR => '/files';
use constant BB_DIR => '/files/BB';
use constant BB_INFO => 'BBFile.txt';
use constant FH_DIR => '/files/FH';
use constant FH_TEMP_INFO => 'FHTemp.txt';
use constant FIX_SIZE => 240007;
use constant THREAD_NUM => 4;
use constant NOTICE => 'FIN';
use constant WARN => 'ERROR';
use constant WEND => 'END';

my @BBFileList;
my @FHList  :shared;
my $execCode;

sub djb2;
sub featureHash;

chdir('..');
my $homedir = getcwd;
chdir($homedir.FILE_DIR);
$execCode = "cat ".BB_INFO;
@BBFileList = `$execCode`;

chdir($homedir.BB_DIR);
my @thread;
for(my $i = 0; $i < THREAD_NUM; ++$i) {
    $thread[$i] = threads->new(\&featureHash, $i);
}
for(my $i = 0; $i < THREAD_NUM; ++$i) {
    $thread[$i]->join;
}

my $fh = FileHandle->new(">".$homedir.FH_DIR."\/".FH_TEMP_INFO);
for(my $i = 0; $i <= $#FHList; ++$i) {
    for(my $j = 0;$j < FIX_SIZE; ++$j) {
        if(defined $FHList[$i][$j] ) {
            print $fh $FHList[$i][$j];
        }
        else {
            print $fh '0';
        }
    }
    print $fh "\n";
}
undef $fh;

print NOTICE."\n";

sub djb2 {
    my $str = shift;
    my $seed = 5381;
    my $c;
    my $i = 1;
    while($c = ${$str}[$i]) {
        $seed = (($seed << 5) + $seed) + $c;
        $i++;
    }
    return $seed;
}

sub featureHash {
    my $start = shift;

    for(my $i = $start; $i <= $#BBFileList; $i = $i + THREAD_NUM) {
        my $BBFile = substr($BBFileList[$i],0,length($BBFileList[$i])-1);
        my $fh2 = FileHandle->new($BBFile);
        my @FH  :shared;
        my @block;
        my $value;
        my $tempLine = $fh2->getline;
        $block[0] = substr($tempLine,0,length($tempLine)-1);
        $tempLine = $fh2->getline;
        $block[1] = substr($tempLine,0,length($tempLine)-1);
        $tempLine = $fh2->getline;
        $block[2] = substr($tempLine,0,length($tempLine)-1);
        $tempLine = $fh2->getline;
        $block[3] = substr($tempLine,0,length($tempLine)-1);
        $tempLine = $fh2->getline;
        while($tempLine = $fh2->getline) {
            $block[4] = substr($tempLine,0,length($tempLine)-1);
            if($block[0] =~ /^[0-9]+\:\#/ || $block[1] =~ /^[0-9]+\:\#/ || $block[2] =~ /^[0-9]+\:\#/ || $block[3] =~ /^[0-9]+\:\#/ || $block[4] =~ /^[0-9]+\:\#/) { 
            }
            else {
                $tempLine = $block[0].$block[1].$block[2].$block[3].$block[4];
                my @char = split('',$tempLine);
                $value = djb2(\@char) % FIX_SIZE;
                $FH[$value] = 1;
            }
            shift @block;
        }
        undef $fh2;
        $FHList[$i] = \@FH;
    }
}
