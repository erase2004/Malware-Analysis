#!/usr/bin/perl
use strict;
use FileHandle;
use Cwd;

use constant FILE_DIR => '/files';
use constant BB_DIR => '/files/BB';
use constant DIR_INFO => 'dir.txt';
use constant PAIR_INFO => 'pair.txt';
use constant WORK_LIST => 'work.txt';
use constant BB_INFO => 'BBFile.txt';
use constant NOTICE => 'FIN';
use constant WARN => 'ERROR';
use constant WEND => 'END';

my @workList;
my @BBFileList;

my $homedir = getcwd;
chdir($homedir.FILE_DIR);
my $fh = FileHandle->new(DIR_INFO);  ##從dir.txt讀取目錄名稱和.smali所在位置

my @tQueue;
while($_ = $fh->getline) {
    @tQueue = split(" ",$_);
    push(@{$workList[0]}, $tQueue[0]);
    push(@{$workList[1]}, $tQueue[1]);
    push(@{$workList[2]}, $tQueue[2]);
}

undef $fh;
for(my $i = 0; $i <= $#{$workList[0]}; ++$i) {                             ##對每組smali所屬的目錄,先過濾出開頭非R,R$的檔案,
                                                                           ##接著在FILE_DIR創建以目錄名稱為參考命名的.bb檔,
                                                                           ##將每組smali檔案轉換成BB的結果儲存於對應.bb檔
    my $BBName = $workList[1][$i];
    my $workDir = $workList[2][$i];
    chdir($workDir);
    my @smaliFiles = `ls | grep -v \^R\[\$\.\]\[a\-zA\-Z\]\*\[\.\]\*smali\$`;
    $BBFileList[$i] = $BBName."\.bb";

    $fh = FileHandle->new(">".$homedir.BB_DIR."\/".$BBFileList[$i]);
    for(my $j = 0; $j <= $#smaliFiles; ++$j) {
        my $smali = substr($smaliFiles[$j],0,length($smaliFiles[$j])-1);
        my $fh2 = FileHandle->new($smali);
        my $pkgName;
        while($_ = $fh2->getline) {  ##取得該smali檔的class資訊
            if(/\.class/) {
                $_ = $';
                /(\w)+\/(\w+)/;
                $pkgName = $&.$';
                last;
            }
        }
        print $fh $j.":#".$pkgName;
        while($_ = $fh2->getline) {  ##過濾出opcode的部分
            if(/^\s*[a-zA-Z]+/) {
                print $fh $_;
            }
        }
        undef $fh2;
    }
    undef $fh;
}
chdir($homedir.FILE_DIR);                        ##回傳FIN訊號給daemon,並將BB檔案資訊儲存於FILE_DIR下的BBFile.txt,
                                                 ##供featureHash.pl使用
$fh = FileHandle->new(">".BB_INFO);
my $fh2 = FileHandle->new(">".WORK_LIST);
my $fh3 = FileHandle->new(">>".PAIR_INFO);
for(my $i; $i <= $#BBFileList; ++$i) {
    print $fh $BBFileList[$i]."\n";
    print $fh2 $workList[0][$i]." ".$workList[1][$i]."\n";
    print $fh3 $workList[0][$i]." ".$workList[1][$i]."\n";
}
undef $fh;
undef $fh2;
undef $fh3;
print NOTICE."\n";

