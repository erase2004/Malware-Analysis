#!/usr/bin/perl
use strict;
use FileHandle;
use File::Copy;
use Cwd;

use constant DIR_INFO => 'dir.txt';
use constant NOTICE => 'FIN';
use constant WARN => 'ERROR';
use constant WEND => 'END';

my @directoryList;
my @outputList;
my $baseDir;
my $execCode;
my @list;

sub findDir;

my $bindir = getcwd;
chdir('../files');
$execCode = "cat ".DIR_INFO;
@directoryList = `$execCode`;
@outputList = (\@directoryList);

$baseDir = `pwd`;
$baseDir = substr($baseDir,0,length($baseDir)-1);

for(my $i = 0; $i <= $#directoryList; ++$i) { ##利用BIN_DIR下的baksmali.jar,將classes.dex轉換成smali format,
                                              ##然後從out資料夾開始,向下尋找到.smali所存放的位
    chdir($baseDir);
    my $nextDir = substr($directoryList[$i],0,length($directoryList[$i])-1);
    chdir($nextDir);
    my $failed = 0;
    my $localDir = $baseDir."\/".$nextDir;
    $execCode = "java -jar ".$bindir."\/baksmali.jar classes.dex";
    `$execCode`;
    undef @list;
    findDir("out");
    @list = map { $localDir."\/".$_ } @list;
    for(my $j = 1; $j <= $#list; ++$j) {
        $execCode = "ls ".$list[$j];
        my @files = `$execCode`;
        for(my $k = 0; $k <= $#files; ++$k) {
            my $oldfile = $list[$j]."\/".substr($files[$k],0,length($files[$k])-1);
            my $newfile = $list[0]."\/".substr($files[$k],0,length($files[$k])-1);
            move($oldfile, $newfile);
        }
    }
    $outputList[1][$i] = $list[0];
}

chdir($baseDir);                              ##回傳FIN訊號給daemon,並將各個classes.dex和.smali所存放的位置資訊,
                                              ##儲存在dir.txt內,供toBasicBlock.pl使用
my $fh = FileHandle->new(">".DIR_INFO);
for(my $i = 0; $i <= $#{$outputList[0]}; ++$i) {
    print $fh $outputList[0][$i].$outputList[1][$i]."\n";
}
undef $fh;
print NOTICE."\n";

sub findDir {
    my $path = shift;
    opendir (DIR, $path);
    my @files = grep { !/^\.{1,2}$/ } readdir (DIR);
    closedir (DIR);
    @files = map { $path.'/'.$_ } @files;

    for (@files) {
        if(-d $_) {
            findDir($_);
        }
        elsif(/\.smali$/) {
            push @list, $path;
            last;
        }
    }
}
