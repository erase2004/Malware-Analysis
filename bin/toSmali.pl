#!/usr/bin/perl
use strict;
use FileHandle;
use File::Copy;
use Cwd;

use constant DIR_INFO => 'dir.txt';
use constant RESULT_INFO => 'result.txt';
use constant NOTICE => 'FIN';
use constant WARN => 'ERROR';
use constant WEND => 'END';

my @apkList;
my @directoryList;
my @outputList;
my @condCodeList;
my $baseDir;
my $execCode;
my @list;

sub findDir;

chdir('bin');
my $bindir = getcwd;
chdir('../files');
my $fh = FileHandle->new(DIR_INFO);
while($_ = $fh->getline) {
    my @tQueue = split(" ",$_);
    push(@apkList, $tQueue[0]);
    push(@directoryList, $tQueue[1]);
}
undef $fh;
@outputList = (\@directoryList);

$baseDir = getcwd;

for(my $i = 0; $i <= $#directoryList; ++$i) { ##利用BIN_DIR下的baksmali.jar,將classes.dex轉換成smali format,
                                              ##然後從out資料夾開始,向下尋找到.smali所存放的位
    chdir($baseDir);
    my $nextDir = $directoryList[$i];
    chdir($nextDir);
    my $localDir = $baseDir."\/".$nextDir;
    $execCode = "java -jar ".$bindir."\/baksmali.jar classes.dex"; 
    my @err = `$execCode 2>&1`;
    if(@err ne "0") {
        $condCodeList[$i] = 11;
        push(@{$outputList[1]}, " ");
        next;
    }
    undef @list;
    findDir("out");
    @list = map { $localDir."\/".$_ } @list;
    for(my $j = 1; $j <= $#list; ++$j) {
        opendir(my $dh, $list[$j]);
        my @files = grep { /.smali$/i } readdir($dh);
        close($dh);
        for(my $k = 0; $k <= $#files; ++$k) {
            my $oldfile = $list[$j]."\/".$files[$k];
            opendir(my $dh2, $list[0]);
            my $head = 0;
            while(1) {
                my $count = grep { /"$files[$k]"/ } readdir($dh2);
                if($count == 0) { last; }
                $files[$k] = $head.$files[$k];
                ++$head;
            }
            my $newfile = $list[0]."\/".$files[$k];
            move($oldfile, $newfile);
            close($dh2);
        }
    }
    push(@{$outputList[1]}, $list[0]);
    $condCodeList[$i] = 10;
}

chdir($baseDir);                              ##回傳FIN訊號給daemon,並將各個classes.dex和.smali所存放的位置資訊,
                                              ##儲存在dir.txt內,供toBasicBlock.pl使用
$fh = FileHandle->new(">".DIR_INFO);
my $fh2 = FileHandle->new(">>".RESULT_INFO);
for(my $i = 0; $i <= $#{$outputList[0]}; ++$i) {
    if($condCodeList[$i] == 10) {
        print $fh $apkList[$i]." ".$outputList[0][$i]." ".$outputList[1][$i]."\n";
    } else {
        print $fh2 $apkList[$i]." ".$condCodeList[$i]."\n";
    }
}
undef $fh;
undef $fh2;
print NOTICE."\n";

sub findDir {
    my $path = shift;
    opendir (DIR, $path);
    my @files = grep { !/^\.{1,2}$/ } readdir (DIR);
    closedir (DIR);
    @files = map { $path.'/'.$_ } @files;
    @files = sort {(-d $a) <=> (-d $b) } @files;
    @files = reverse (@files);

    for (@files) {
        if(-d $_) {
            findDir($_);
        }
        elsif(/\.smali$/) {
            push @list, $path;
            last;
        }
    }
}
