#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <fcntl.h>
#include <signal.h>
#include <unistd.h>
#include <time.h>

#define BIN_DIR     "bin/"
#define LOCK_FILE	"pdaemon.lock"
#define LOG_DIR     "log/"
#define LOG_FILE    "pdaemon.log"
#define FIN         "FIN\n"
#define WARN        "ERROR\n"
#define WEND        "END\n"

void daemonize();
void signal_handler(int sig);
void log_message(char* filename,char* message);
char **directoryList;
char cmdbuf[128];
char logbuf[256];
time_t currentTime;

void main()
{
    daemonize();

    while(1)
    {
        sprintf(cmdbuf,"perl %sunzip.pl",BIN_DIR);
        FILE *fp=popen(cmdbuf,"r");
        if(fp==NULL)
        {
            log_message(LOG_FILE,"Popen(\"perl unzip\") error!\n");
        }
        char buf[48];
        int i;
        
        while(fgets(buf,sizeof(buf),fp))
        {
            if(!strcmp(buf,WARN))
            {
                while(fgets(logbuf,sizeof(logbuf),fp))
                {
                    if(!strcmp(logbuf,WEND)) break;
                    else log_message(LOG_FILE,logbuf);
                }
            }
            else if(!strcmp(buf,FIN)) break;
        }
        fgets(buf,sizeof(buf),fp);
        int fileCount = atoi(buf);

        if (fileCount !=0)
        {
            sprintf(logbuf,"Unzip %d files.\n",fileCount);
            log_message(LOG_FILE,logbuf);

            sprintf(cmdbuf,"perl %stoSmali.pl",BIN_DIR);
            FILE *fp2=popen(cmdbuf,"r");
            while(fgets(buf,sizeof(buf),fp2))
            {
                if(!strcmp(buf,WARN))
                {
                    while(fgets(logbuf,sizeof(logbuf),fp))
                    {
                        if(!strcmp(logbuf,WEND)) break;
                        else log_message(LOG_FILE,logbuf);
                    }
                }
                else if(!strcmp(buf,FIN)) break;
            }
            pclose(fp2);
            sprintf(logbuf,"Convert files to Smali completed.\n");
            log_message(LOG_FILE,logbuf);

            sprintf(cmdbuf,"perl %stoBasicBlock.pl",BIN_DIR);
            fp2 = popen(cmdbuf,"r");
            while(fgets(buf,sizeof(buf),fp2))
            {
                if(!strcmp(buf,WARN))
                {
                    while(fgets(logbuf,sizeof(logbuf),fp))
                    {
                        if(!strcmp(logbuf,WEND)) break;
                        else log_message(LOG_FILE,logbuf);
                    }
                }
                else if(!strcmp(buf,FIN)) break;
            }
            pclose(fp2);
            sprintf(logbuf,"Convert files to BBFormat completed.\n");
            log_message(LOG_FILE,logbuf);

            sprintf(cmdbuf,"perl %sfeatureHash.pl",BIN_DIR);
            fp2 = popen(cmdbuf,"r");
            while(fgets(buf,sizeof(buf),fp2))
            {
                if(!strcmp(buf,WARN))
                {
                    while(fgets(logbuf,sizeof(logbuf),fp))
                    {
                        if(!strcmp(logbuf,WEND)) break;
                        else log_message(LOG_FILE,logbuf);
                    }
                }
                else if(!strcmp(buf,FIN)) break;
            }
            pclose(fp2);
            sprintf(logbuf,"Feature hashing completed.\n");
            log_message(LOG_FILE,logbuf);

            sprintf(cmdbuf,"perl %sdistance.pl",BIN_DIR);
            fp2 = popen(cmdbuf,"r");
            while(fgets(buf,sizeof(buf),fp2))
            {
                if(!strcmp(buf,WARN))
                {
                    while(fgets(logbuf,sizeof(logbuf),fp))
                    {
                        if(!strcmp(logbuf,WEND)) break;
                        else log_message(LOG_FILE,logbuf);
                    }
                }
                else if(!strcmp(buf,FIN)) break;
            }
            pclose(fp2);
            sprintf(logbuf,"Distance calculation completed.\n");
            log_message(LOG_FILE,logbuf);

            sprintf(cmdbuf,"perl %ssimilarity.pl",BIN_DIR);
            fp2 = popen(cmdbuf,"r");
            while(fgets(buf,sizeof(buf),fp2))
            {
                if(!strcmp(buf,WARN))
                {
                    while(fgets(logbuf,sizeof(logbuf),fp))
                    {
                        if(!strcmp(logbuf,WEND)) break;
                        else log_message(LOG_FILE,logbuf);
                    }
                }
                else if(!strcmp(buf,FIN)) break;
            }
            pclose(fp2);
            sprintf(logbuf,"Similarity test completed.\n");
            log_message(LOG_FILE,logbuf);

            sprintf(cmdbuf,"perl %smainDetect.pl",BIN_DIR);
            fp2 = popen(cmdbuf,"r");
            while(fgets(buf,sizeof(buf),fp2))
            {
                if(!strcmp(buf,WARN))
                {
                    while(fgets(logbuf,sizeof(logbuf),fp))
                    {
                        if(!strcmp(logbuf,WEND)) break;
                        else log_message(LOG_FILE,logbuf);
                    }
                }
                else if(!strcmp(buf,FIN)) break;
            }
            pclose(fp2);
            sprintf(logbuf,"Permission test completed.\n");
            log_message(LOG_FILE,logbuf);
        }
        else
        {
        }
        pclose(fp);
        sleep(1);
    }
    return;
}

void daemonize()
{
    int i,lfp;
    char str[10];
    if (getppid()==1) return;
    i=fork();
    if (i<0) exit(1);
    if (i>0) exit(0);
    setsid();
    for (i=getdtablesize();i>=0;--i) close(i);
    i=open("/dev/null",O_RDWR);
    dup(i);
    dup(i);
    umask(027);
    //chdir();
    lfp=open(LOCK_FILE,O_RDWR|O_CREAT,0640);
    if (lfp<0) exit(1);
    if(lockf(lfp,F_TLOCK,0)<0) exit(0);
    sprintf(str,"%d\n",getpid());
    write(lfp,str,strlen(str));
    signal(SIGCHLD,SIG_IGN);
    signal(SIGTSTP,SIG_IGN);
    signal(SIGTTOU,SIG_IGN);
    signal(SIGTTIN,SIG_IGN);
    signal(SIGHUP,signal_handler);
    signal(SIGTERM,signal_handler);
    log_message(LOG_FILE,"Daemon starts successfully.\n");
}

void signal_handler(int sig)
{
    switch(sig) {
        case SIGHUP:
            log_message(LOG_FILE,"Hangup signal catched.\n");
            break;
        case SIGTERM:
		    log_message(LOG_FILE,"Terminate signal catched.\n");
		    exit(0);
            break;
    }
}

void log_message(char* filename,char* message)
{
    FILE *logfile;
    char timebuf[30];
    char log[128];
    sprintf(log,"%s%s",LOG_DIR,filename);
    logfile=fopen(log,"a");
    if(!logfile) return;
    time(&currentTime);
    sprintf(timebuf,"%s",ctime(&currentTime));
    timebuf[strlen(timebuf)-1]='\0';
    fprintf(logfile,"%s  %s",timebuf,message);
    fclose(logfile);
}
